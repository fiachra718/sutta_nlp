<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Facet Form</title>
  <style>
    body {
      margin: 24px auto;
      max-width: 640px;
      padding: 0 16px;
      font-family: system-ui, -apple-system, Segoe UI, sans-serif;
    }
    form {
      display: grid;
      gap: 12px;
    }
    label {
      font-size: 14px;
      color: #334155;
    }
    input, select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }
    button {
      width: max-content;
      padding: 8px 14px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: #f8fafc;
      cursor: pointer;
    }
    #results {
      margin-top: 24px;
      display: grid;
      gap: 16px;
    }
    .result {
      padding: 12px 14px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: #ffffff;
    }
    .result-meta {
      font-size: 12px;
      color: #475569;
      margin-bottom: 6px;
    }
    .result-text {
      font-size: 14px;
      line-height: 1.45;
      color: #0f172a;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <form id="facet-form">
    <div>
      <label for="query">Text</label>
      <input id="query" name="query" type="text" />
    </div>
    <div>
      <label for="person">Person</label>
      <select id="person" name="person">
        <option value="">Select person</option>
      </select>
    </div>
    <div>
      <label for="loc">Loc</label>
      <select id="loc" name="loc">
        <option value="">Select loc</option>
      </select>
    </div>
    <div>
      <label for="gpe">GPE</label>
      <select id="gpe" name="gpe">
        <option value="">Select gpe</option>
      </select>
    </div>
    <div>
      <button type="submit">Submit</button>
      <button type="button" id="clear-selection">Clear</button>
    </div>
  </form>
  <div id="results"></div>
  <script>
    const personSelect = document.querySelector("#person");
    const locSelect = document.querySelector("#loc");
    const gpeSelect = document.querySelector("#gpe");
    const form = document.querySelector("#facet-form");
    const results = document.querySelector("#results");
    const clearButton = document.querySelector("#clear-selection");

    function setOptions(select, values, selectedValue) {
      const placeholder = select.querySelector("option[value=\"\"]");
      select.innerHTML = "";
      if (placeholder) {
        select.appendChild(placeholder);
      }
      if (selectedValue && !values.includes(selectedValue)) {
        values = [selectedValue, ...values];
      }
      values.forEach((value) => {
        const option = document.createElement("option");
        option.value = value;
        option.textContent = value;
        if (value === selectedValue) {
          option.selected = true;
        }
        select.appendChild(option);
      });
      if (selectedValue && !values.includes(selectedValue)) {
        select.value = "";
      }
    }

    async function refreshFacets() {
      const payload = {
        person: personSelect.value || null,
        gpe: gpeSelect.value || null,
        loc: locSelect.value || null,
      };
      try {
        const response = await fetch("/api/facets/context", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await response.json();
        if (!data.ok) {
          throw new Error(data.error || "facet request failed");
        }
        const facets = data.facets || {};
        const keepPerson = personSelect.value || "";
        const keepGpe = gpeSelect.value || "";
        const keepLoc = locSelect.value || "";
        setOptions(personSelect, facets.PERSON || [], keepPerson);
        setOptions(gpeSelect, facets.GPE || [], keepGpe);
        setOptions(locSelect, facets.LOC || [], keepLoc);
      } catch (error) {
        console.error("Failed to refresh facets", error);
      }
    }

    personSelect.addEventListener("change", refreshFacets);
    gpeSelect.addEventListener("change", refreshFacets);
    locSelect.addEventListener("change", refreshFacets);
    refreshFacets();

    clearButton.addEventListener("click", () => {
      personSelect.value = "";
      gpeSelect.value = "";
      locSelect.value = "";
      results.innerHTML = "";
      refreshFacets();
    });

    function renderResults(items) {
      if (!items.length) {
        results.innerHTML = "<p>No verses found.</p>";
        return;
      }
      const rows = items.map((item) => {
        const header = [
          item.identifier,
          item.canon_ref || "",
          `v${item.verse_num}`,
        ].filter(Boolean).join(" Â· ");
        return `
          <div class="result">
            <div class="result-meta">${header}</div>
            <div class="result-text">${item.text || ""}</div>
          </div>
        `;
      });
      results.innerHTML = rows.join("");
    }

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const payload = {
        person: personSelect.value || null,
        gpe: gpeSelect.value || null,
        loc: locSelect.value || null,
        limit: 50,
      };
      try {
        const response = await fetch("/api/facets/verses", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await response.json();
        if (!data.ok) {
          throw new Error(data.error || "facet search failed");
        }
        renderResults(data.items || []);
      } catch (error) {
        console.error("Failed to load verses", error);
        results.innerHTML = "<p>Unable to load verses.</p>";
      }
    });
  </script>
</body>
</html>
