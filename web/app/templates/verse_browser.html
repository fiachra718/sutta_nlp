<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Verse Browser</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/ner.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/verse_browser.css') }}">
</head>
<body class="verse-browser">
  <h1>Browse Verses</h1>
  <form class="filters" method="get" id="verse-filter-form">
    <label>
      Nikaya
      <select name="nikaya" id="filter-nikaya">
        <option value="">Any</option>
        {% for item in facets.nikayas %}
        <option value="{{ item }}" {% if filters.nikaya == item %}selected{% endif %}>{{ item }}</option>
        {% endfor %}
      </select>
    </label>
    <label>
      Book Number
      <select name="book_number" id="filter-book">
        <option value="">Any</option>
        {% for item in facets.book_numbers %}
        <option value="{{ item }}" {% if filters.book_number == item %}selected{% endif %}>{{ item }}</option>
        {% endfor %}
      </select>
    </label>
    <label>
      Vagga
      <select name="vagga" id="filter-vagga">
        <option value="">Any</option>
        {% for item in facets.vaggas %}
        <option value="{{ item }}" {% if filters.vagga == item %}selected{% endif %}>{{ item }}</option>
        {% endfor %}
      </select>
    </label>
    <label>
      Verse #
      <input type="number" name="verse_num" min="1" step="1" value="{{ filters.verse_num }}">
    </label>
    <label>
      Limit
      <input type="number" name="limit" min="1" max="500" value="{{ filters.limit }}">
    </label>
    <div class="actions">
      <button class="primary" type="submit">Search</button>
      <a href="{{ url_for('browse_verses') }}">Reset</a>
    </div>
  </form>

  <section>
    <h2>Results ({{ verses|length }})</h2>
    {% if verses %}
    <table>
      <thead>
        <tr>
          <th>Metadata</th>
          <th>Identifier</th>
          <th>Verse #</th>
          <th>Text</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for verse in verses %}
        <tr>
          <td class="meta">
            {% if verse.nikaya %}Nikaya: {{ verse.nikaya }}<br>{% endif %}
            {% if verse.book_number %}Book: {{ verse.book_number }}<br>{% endif %}
            {% if verse.vagga %}Vagga: {{ verse.vagga }}<br>{% endif %}
            {% if verse.title %}Title: {{ verse.title }}{% endif %}
          </td>
          <td>{{ verse.identifier }}</td>
          <td>{{ verse.verse_num + 1 }}</td>
          <td class="text-snippet">{{ verse.text }}</td>
          <td>
            <a href="{{ url_for('sutta_verse', identifier=verse.identifier, verse_num=verse.verse_num) }}" target="_blank">JSON</a>
            |
            <a href="{{ url_for('predict_verse', identifier=verse.identifier, verse_num=verse.verse_num) }}" target="_blank">Predict</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
      <p>No verses found for this filter set.</p>
    {% endif %}
  </section>
  <script>
    (function() {
      const INITIAL_FILTERS = {{ filters | tojson | safe }};
      const nikayaSelect = document.getElementById("filter-nikaya");
      const bookSelect = document.getElementById("filter-book");
      const vaggaSelect = document.getElementById("filter-vagga");

      function setEnabled(control, enabled) {
        if (!control) return;
        control.disabled = !enabled;
        if (!enabled) {
          control.value = "";
        }
      }

      function populateSelect(select, values, preferred) {
        if (!select) return;
        const normalized = Array.isArray(values) ? values.map(String) : [];
        const previous = select.value;
        const options = ['<option value="">Any</option>'].concat(
          normalized.map(val => `<option value="${val}">${val}</option>`)
        );
        select.innerHTML = options.join("");
        let target = "";
        if (preferred && normalized.includes(preferred)) {
          target = preferred;
        } else if (normalized.includes(previous)) {
          target = previous;
        }
        select.value = target;
      }

      async function refreshFacetOptions() {
        const nikaya = (nikayaSelect?.value || "").trim();
        if (!nikaya) {
          populateSelect(bookSelect, [], "");
          populateSelect(vaggaSelect, [], "");
          return;
        }
        const params = new URLSearchParams({ nikaya });
        const bookValue = (bookSelect?.value || "").trim();
        if (bookValue) {
          params.append("book_number", bookValue);
        }
        try {
          const response = await fetch(`/api/verses/facets?${params.toString()}`);
          const payload = await response.json();
          populateSelect(bookSelect, payload.book_numbers || [], bookValue || INITIAL_FILTERS.book_number);
          const currentBook = (bookSelect?.value || "").trim();
          const vaggaPref = (vaggaSelect?.value || "").trim() || INITIAL_FILTERS.vagga;
          populateSelect(
            vaggaSelect,
            payload.vaggas || [],
            currentBook ? vaggaPref : ""
          );
        } catch (error) {
          console.error("Unable to load facets", error);
          populateSelect(bookSelect, [], "");
          populateSelect(vaggaSelect, [], "");
        }
      }

      function syncControls() {
        const value = (nikayaSelect?.value || "").trim().toUpperCase();
        if (!value) {
          setEnabled(bookSelect, false);
          setEnabled(vaggaSelect, false);
          populateSelect(bookSelect, [], "");
          populateSelect(vaggaSelect, [], "");
          return;
        }
        if (value === "DN" || value === "MN") {
          setEnabled(bookSelect, true);
          setEnabled(vaggaSelect, false);
        } else if (value === "SN" || value === "AN" || value === "KN") {
          setEnabled(bookSelect, true);
          setEnabled(vaggaSelect, true);
        } else {
          setEnabled(bookSelect, false);
          setEnabled(vaggaSelect, false);
        }
        refreshFacetOptions();
      }

      nikayaSelect?.addEventListener("change", () => {
        bookSelect.value = "";
        vaggaSelect.value = "";
        syncControls();
      });
      bookSelect?.addEventListener("change", () => {
        refreshFacetOptions();
      });

      syncControls();
    })();
  </script>
</body>
</html>
