WITH gold_norp AS (
    SELECT
        lower(btrim(s->>'text')) AS norp,
        COUNT(*) AS gold_freq
    FROM gold_training gt
    CROSS JOIN LATERAL jsonb_array_elements(gt.spans) AS s
    WHERE s->>'label' = 'NORP'
      AND btrim(s->>'text') <> ''
    GROUP BY 1
),
ati_norp AS (
    SELECT
        lower(btrim(s->>'text')) AS norp,
        COUNT(*) AS ati_freq
    FROM ati_verses av
    CROSS JOIN LATERAL jsonb_array_elements(av.ner_span) AS s
    WHERE s->>'label' = 'NORP'
      AND btrim(s->>'text') <> ''
    GROUP BY 1
)
SELECT
    COALESCE(a.norp, g.norp) AS norp,
    g.gold_freq,
    a.ati_freq,
    CASE
      WHEN g.norp IS NULL THEN 'ati_not_in_gold'
      WHEN a.norp IS NULL THEN 'gold_not_in_ati'
    END AS diff_type
FROM gold_norp g
FULL OUTER JOIN ati_norp a USING (norp)
WHERE g.norp IS NULL OR a.norp IS NULL
ORDER BY COALESCE(a.ati_freq, 0) DESC,
         COALESCE(g.gold_freq, 0) DESC,
         norp;


         norp          | gold_freq | ati_freq |    diff_type    
-----------------------+-----------+----------+-----------------
 nāga                  |           |        4 | ati_not_in_gold
 four great king devas |           |        3 | ati_not_in_gold
 kosalan brahman       |           |        3 | ati_not_in_gold
 lay men               |           |        3 | ati_not_in_gold
 nāgas                 |           |        3 | ati_not_in_gold
 perfected ones        |           |        2 | ati_not_in_gold
 sakyan clan           |           |        2 | ati_not_in_gold
 upright ones          |           |        2 | ati_not_in_gold
 yama gods             |           |        2 | ati_not_in_gold
 ariyan                |           |        1 | ati_not_in_gold
 ariyan discipline     |           |        1 | ati_not_in_gold
 aryan                 |           |        1 | ati_not_in_gold
 brahmaas              |           |        1 | ati_not_in_gold
 indras                |           |        1 | ati_not_in_gold
 maaras                |           |        1 | ati_not_in_gold
 male lay follower     |           |        1 | ati_not_in_gold
 male lay-followers    |           |        1 | ati_not_in_gold
 noble ariya           |           |        1 | ati_not_in_gold
 noble queen           |           |        1 | ati_not_in_gold
 noble-warriors        |           |        1 | ati_not_in_gold
 paragas               |           |        1 | ati_not_in_gold
 sahabhu devas         |           |        1 | ati_not_in_gold
 sakya clan            |           |        1 | ati_not_in_gold
 sakyan contemplative  |           |        1 | ati_not_in_gold
 sakyan contemplatives |           |        1 | ati_not_in_gold
 subhakinha            |           |        1 | ati_not_in_gold
 sunaparantans         |           |        1 | ati_not_in_gold
 suttantas             |           |        1 | ati_not_in_gold
 udaññans              |           |        1 | ati_not_in_gold
 anguttarapan          |         2 |          | gold_not_in_ati
 bhaaradvaaja brahmans |         2 |          | gold_not_in_ati
 bhikkhu-sangha        |         2 |          | gold_not_in_ati
 female novices        |         2 |          | gold_not_in_ati
 merchant              |         2 |          | gold_not_in_ati
 arahant monks         |         1 |          | gold_not_in_ati
 brahmanas             |         1 |          | gold_not_in_ati
 deities               |         1 |          | gold_not_in_ati
 deva-king             |         1 |          | gold_not_in_ati
 kalakañjas            |         1 |          | gold_not_in_ati
 warriors              |         1 |          | gold_not_in_ati
(40 rows)
